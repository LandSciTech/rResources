<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Why use functions • rResources</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Why use functions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rResources</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/functions.html">Why use functions</a></li>
    <li><a class="dropdown-item" href="../articles/good_code.html">Minimum requirements for good code</a></li>
    <li><a class="dropdown-item" href="../articles/package_development.html">R package development</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Why use functions</h1>
                        <h4 data-toc-skip class="author">Sarah Endicott
and David Hope</h4>
            
      

      <div class="d-none name"><code>functions.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="disclaimer">Disclaimer<a class="anchor" aria-label="anchor" href="#disclaimer"></a>
</h3>
<p>Much of the examples and code here comes from Hadley Wickham et al’s
books <a href="https://r4ds.hadley.nz/functions.html" class="external-link">R for data
science</a> and <a href="https://r-pkgs.org/package-within.html" class="external-link">R
packages</a>.</p>
<p>As such, you’ll need to use the “<a href="https://www.tidyverse.org/" class="external-link">tidyverse</a>” metapackage to follow
along with today’s code. Use <code>install.packages("tidyverse")</code>
to install the complete set of packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<p>You might also want the “<a href="https://testthat.r-lib.org/" class="external-link">testthat</a>” package, though that
isn’t necessary for most what we’ll show today.</p>
</div>
<div class="section level2">
<h2 id="why-use-functions">Why use functions<a class="anchor" aria-label="anchor" href="#why-use-functions"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Avoid copy paste errors</p></li>
<li><p>Only update code in one place</p></li>
<li><p>Reuse code across different projects</p></li>
<li><p>Simplify code so repetition is hidden and differences are
clear</p></li>
<li><p>You can give a function an evocative name that makes your code
easier to understand.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="when-to-write-a-function">When to write a function<a class="anchor" aria-label="anchor" href="#when-to-write-a-function"></a>
</h2>
<p>This is the advice of Hadley Wickham:</p>
<blockquote>
<p><a href="https://r4ds.hadley.nz/functions.html#introduction" class="external-link">A good
rule of thumb is to consider writing a function whenever you’ve copied
and pasted a block of code more than twice (i.e. you now have three
copies of the same code)</a>.</p>
</blockquote>
<p>This often means re-writing the first two spots where you used the
code but it is worth it.</p>
<div class="section level3">
<h3 id="example-one">Example 1<a class="anchor" aria-label="anchor" href="#example-one"></a>
</h3>
<p>Here is an example of repetition we can avoid by using a
function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, d <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>  </span>
<span>  a <span class="op">=</span> <span class="op">(</span><span class="va">a</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="op">(</span><span class="va">b</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  c <span class="op">=</span> <span class="op">(</span><span class="va">c</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  d <span class="op">=</span> <span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;       a       b     c     d</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0.339  0.387  0.291 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 0.880 -<span style="color: #BB0000;">0.613</span>  0.611 0.557</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 0     -<span style="color: #BB0000;">0.083</span><span style="color: #BB0000; text-decoration: underline;">3</span> 1     0.752</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 0.795 -<span style="color: #BB0000;">0.082</span><span style="color: #BB0000; text-decoration: underline;">2</span> 0     1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1     -<span style="color: #BB0000;">0.095</span><span style="color: #BB0000; text-decoration: underline;">2</span> 0.580 0.394</span></span></code></pre></div>
<p>Can you spot the copy-paste error above? How would you discover this
error in the resulting output?</p>
<p>Now that we fixed that, how can we turn this into a function?</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>  </span>
<span>  a <span class="op">=</span> <span class="op">(</span><span class="va">a</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="op">(</span><span class="va">b</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  c <span class="op">=</span> <span class="op">(</span><span class="va">c</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  d <span class="op">=</span> <span class="op">(</span><span class="va">d</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;       a     b     c     d</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0.339 1     0.291 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 0.880 0     0.611 0.557</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 0     0.530 1     0.752</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 0.795 0.531 0     1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1     0.518 0.580 0.394</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Identify parts that are the same across repetitions and “factor out”
the parts that are different. This is the function
<strong>body</strong>
</li>
</ol>
<p>For example, if we replace all the letters with <code>x</code> the
rest is the same.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Choose a clear <strong>name</strong> that tells us what the function
does. Ideally a verb. Lets use <code>rescale01</code> since the code
rescales the vector to 0-1.</li>
<li>Name the parts that will change between uses, these are the
<strong>arguments</strong>. <code>x</code> is a conventional name for a
numeric vector.</li>
</ol>
<p>Function template:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">name</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arguments</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">body</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Filling in the template we get:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rescale01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then when we use the function in our code we can clearly see that we
are applying the same rescaling across each column.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>  </span>
<span>  a <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">a</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">b</span><span class="op">)</span>,</span>
<span>  c <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">c</span><span class="op">)</span>,</span>
<span>  d <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;       a     b     c     d</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0.339 1     0.291 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 0.880 0     0.611 0.557</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 0     0.530 1     0.752</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 0.795 0.531 0     1    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1     0.518 0.580 0.394</span></span></code></pre></div>
<p>Note: you can decrease repetition even more using iteration eg
<code>df |&gt; mutate(across(a:d, rescale01))</code>. See <a href="https://r4ds.hadley.nz/iteration.html" class="external-link">R for Data Science Chapter
26</a> for more on this.</p>
<p>What if we try our function on data containing an
<code>NA</code>?</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rescale01</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] NA NA NA NA NA NA NA NA NA NA NA</span></span></code></pre></div>
<p>All we need to do is change the definition of the function in one
place so that we can handle NAs appropriately:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rescale01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span><span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now our new function will allow for your collaborator to include
missing data and not ruin your analysis.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># This line adds a row with just the column d included</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>d <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>  </span>
<span>  a <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">a</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">b</span><span class="op">)</span>,</span>
<span>  c <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">c</span><span class="op">)</span>,</span>
<span>  d <span class="op">=</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt;        a      b      c     d</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  0.339  1      0.291 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  0.880  0      0.611 0.468</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  0      0.530  1     0.632</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  0.795  0.531  0     0.840</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  1      0.518  0.580 0.331</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>     1</span></span></code></pre></div>
<p>Below we talk more about anticipating these types of failures before
they happen and using testing to ensure your functions are robust.</p>
</div>
</div>
<div class="section level2">
<h2 id="what-is-a-function">What is a function?<a class="anchor" aria-label="anchor" href="#what-is-a-function"></a>
</h2>
<p>A function is an object in R just like a vector or a data frame. A
function can be defined in a package (eg: <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate</a></code>) or
created in an R session. As mentioned above a function has three parts
that need to be defined, the <strong>name</strong>,
<strong>arguments</strong> and <strong>body</strong>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">name</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arguments</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">body</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <strong>name</strong> is what you use to call the function
(<code>rescale01</code>), the <strong>arguments</strong> are what you
provide to the function (<code>x</code> in <code>rescale01</code>) and
the body is where the function does the work.</p>
<div class="section level3">
<h3 id="environments">Environments<a class="anchor" aria-label="anchor" href="#environments"></a>
</h3>
<p>There is one additional part of a function that is implicitly created
when the function is created which is an <strong>environment</strong>.
An environment is the place where code looks for objects that are
called. It is associated with the <strong>body</strong> of the
function.</p>
<p>For example, above we defined two objects <code>df</code> and
<code>rescale01</code> which are both stored in the “Global environment”
and are listed in the Environment pane in RStudio. The Global
environment is the first place code run in the Console will look for an
object.</p>
<p>But inside the body of our function <code>rescale01</code> we also
defined an object <code>x</code>.</p>
<p>Does <code>x</code> exist?</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span></span>
<span><span class="co">#&gt; Error: object 'x' not found</span></span></code></pre></div>
<p>No! It doesn’t exist in the Global environment, it only exists inside
the function’s environment. Objects created inside a function are not
available in the Global environment. Only the result of the last
expression evaluated in the function will be returned.</p>
<p>For example:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rescale01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"data rescaled"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; data rescaled</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>This returned NULL since that is the value returned by
<code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code>.</p>
<p>To return the rescaled data we assign it to an object and then
evaluate the object last.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rescale01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"data rescaled"</span><span class="op">)</span></span>
<span> <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">rescale01</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; data rescaled</span></span>
<span><span class="co">#&gt;           a         b         c         d</span></span>
<span><span class="co">#&gt; 1 0.2303762 0.7964117 0.4183571 0.1275467</span></span>
<span><span class="co">#&gt; 2 0.5980471 0.1366962 0.6810416 0.4253950</span></span>
<span><span class="co">#&gt; 3 0.0000000 0.4864056 1.0000000 0.5296555</span></span>
<span><span class="co">#&gt; 4 0.5401014 0.4870998 0.1790810 0.6619434</span></span>
<span><span class="co">#&gt; 5 0.6793915 0.4785473 0.6551536 0.3383143</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="converting-existing-scripts-to-use-functions">Converting existing scripts to use functions<a class="anchor" aria-label="anchor" href="#converting-existing-scripts-to-use-functions"></a>
</h2>
<div class="section level3">
<h3 id="example-2">Example 2<a class="anchor" aria-label="anchor" href="#example-2"></a>
</h3>
<p>Imagine we have a script to process csv files containing observations
of temperature and location from swimmers.</p>
<p>This is the R script:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span></span>
<span><span class="va">swims_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">infile</span><span class="op">)</span></span>
<span><span class="va">swims</span> <span class="op">&lt;-</span> <span class="va">swims_in</span></span>
<span><span class="va">swims</span></span>
<span><span class="co">#&gt;   name    where temp</span></span>
<span><span class="co">#&gt; 1 Adam    beach   95</span></span>
<span><span class="co">#&gt; 2 Bess    coast   91</span></span>
<span><span class="co">#&gt; 3 Cora seashore   28</span></span>
<span><span class="co">#&gt; 4 Dale    beach   85</span></span>
<span><span class="co">#&gt; 5 Evan  seaside   31</span></span>
<span></span>
<span><span class="co"># Assume country based on name for beach</span></span>
<span><span class="va">swims</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">swims</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"beach"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"US"</span></span>
<span><span class="va">swims</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">swims</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"coast"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"US"</span></span>
<span><span class="va">swims</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">swims</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"seashore"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"UK"</span></span>
<span><span class="va">swims</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">swims</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"seaside"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"UK"</span></span>
<span></span>
<span><span class="co"># Assume Farenheit for US</span></span>
<span><span class="va">swims</span><span class="op">$</span><span class="va">temp</span><span class="op">[</span><span class="va">swims</span><span class="op">$</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">swims</span><span class="op">$</span><span class="va">temp</span><span class="op">[</span><span class="va">swims</span><span class="op">$</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">/</span><span class="fl">9</span></span>
<span><span class="va">swims</span></span>
<span><span class="co">#&gt;   name    where     temp english</span></span>
<span><span class="co">#&gt; 1 Adam    beach 35.00000      US</span></span>
<span><span class="co">#&gt; 2 Bess    coast 32.77778      US</span></span>
<span><span class="co">#&gt; 3 Cora seashore 28.00000      UK</span></span>
<span><span class="co">#&gt; 4 Dale    beach 29.44444      US</span></span>
<span><span class="co">#&gt; 5 Evan  seaside 31.00000      UK</span></span>
<span></span>
<span><span class="co"># save result with a timestamp</span></span>
<span><span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">now</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">outfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">timestamp</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2025-April-23_16-01-26_swim_clean.csv"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">swims</span>, file <span class="op">=</span> <span class="va">outfile</span>, quote <span class="op">=</span> <span class="cn">FALSE</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>This is an example of how functions can help to simplify code even
when there isn’t a lot of repetition.</p>
<p>First we make a function to assign a country based on the name used
for the swimming location. This uses a look up table rather than
assigning each directly to reduce the repeated
<code>swims$english[swims$where ==</code> calls.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">localize_beach</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lookup_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">where</span>, <span class="op">~</span><span class="va">english</span>,</span>
<span>    <span class="st">"beach"</span>,     <span class="st">"US"</span>,</span>
<span>    <span class="st">"coast"</span>,     <span class="st">"US"</span>,</span>
<span>    <span class="st">"seashore"</span>,     <span class="st">"UK"</span>,</span>
<span>    <span class="st">"seaside"</span>,     <span class="st">"UK"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">lookup_table</span>, by <span class="op">=</span> <span class="st">"where"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">swims_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">localize_beach</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   name    where temp english</span></span>
<span><span class="co">#&gt; 1 Adam    beach   95      US</span></span>
<span><span class="co">#&gt; 2 Bess    coast   91      US</span></span>
<span><span class="co">#&gt; 3 Cora seashore   28      UK</span></span>
<span><span class="co">#&gt; 4 Dale    beach   85      US</span></span>
<span><span class="co">#&gt; 5 Evan  seaside   31      UK</span></span></code></pre></div>
<p>Then we write two functions, one to convert F to C and another that
applies <code>f_to_c()</code> to US temperatures in a data frame.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_to_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">/</span><span class="fl">9</span></span>
<span></span>
<span><span class="va">celsify_temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dat</span>, temp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span>, <span class="fu">f_to_c</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="va">temp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">swims_in</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">localize_beach</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">celsify_temp</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   name    where     temp english</span></span>
<span><span class="co">#&gt; 1 Adam    beach 35.00000      US</span></span>
<span><span class="co">#&gt; 2 Bess    coast 32.77778      US</span></span>
<span><span class="co">#&gt; 3 Cora seashore 28.00000      UK</span></span>
<span><span class="co">#&gt; 4 Dale    beach 29.44444      US</span></span>
<span><span class="co">#&gt; 5 Evan  seaside 31.00000      UK</span></span></code></pre></div>
<p>Finally, one more function to create the output file name</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">now</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">timestamp</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span><span class="va">infile</span>, <span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">outfile_path</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2025-April-23_16-01-26_swim_clean.csv"</span></span></code></pre></div>
<p>To keep our script tidy we can move the functions we have defined
into a separate script. Eg <code>cleaning-funs.R</code></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define functions</span></span>
<span><span class="va">localize_beach</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lookup_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">where</span>, <span class="op">~</span><span class="va">english</span>,</span>
<span>    <span class="st">"beach"</span>,     <span class="st">"US"</span>,</span>
<span>    <span class="st">"coast"</span>,     <span class="st">"US"</span>,</span>
<span>    <span class="st">"seashore"</span>,     <span class="st">"UK"</span>,</span>
<span>    <span class="st">"seaside"</span>,     <span class="st">"UK"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">lookup_table</span>, by <span class="op">=</span> <span class="st">"where"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">f_to_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">/</span><span class="fl">9</span></span>
<span></span>
<span><span class="va">celsify_temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">dat</span>, temp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span>, <span class="fu">f_to_c</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="va">temp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">now</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">timestamp</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span><span class="va">infile</span>, <span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Putting that all together we get a simpler script where the function
names tell us what the code is doing.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"cleaning-funs.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span></span>
<span><span class="va">swims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">infile</span><span class="op">)</span></span>
<span></span>
<span><span class="va">swims</span> <span class="op">&lt;-</span> <span class="va">swims</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">localize_beach</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">celsify_temp</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">swims</span></span>
<span><span class="co">#&gt;   name    where     temp english</span></span>
<span><span class="co">#&gt; 1 Adam    beach 35.00000      US</span></span>
<span><span class="co">#&gt; 2 Bess    coast 32.77778      US</span></span>
<span><span class="co">#&gt; 3 Cora seashore 28.00000      UK</span></span>
<span><span class="co">#&gt; 4 Dale    beach 29.44444      US</span></span>
<span><span class="co">#&gt; 5 Evan  seaside 31.00000      UK</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">swims</span>, <span class="fu">outfile_path</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The tricky question is how much simplification is useful? Here the
script is simpler and makes it pretty clear what the steps of the
cleaning process are but it hides the assumption that we can classify
country based on beach name and temperature units based on that country.
Whether that is desirable depends on the use case of the code.</p>
<p>One useful tool for navigating code containing functions in RStudio
is F2. If you place your cursor inside a function name and press F2 you
will jump to the definition of the function. This allows readers that
care about the details to easily navigate to them.</p>
</div>
</div>
<div class="section level2">
<h2 id="benefits-of-a-functional-mindset">Benefits of a functional mindset<a class="anchor" aria-label="anchor" href="#benefits-of-a-functional-mindset"></a>
</h2>
<p>Once you start using functions in your code you will start to notice
more opportunities to reduce repetition and write more efficient
code.</p>
<div class="section level3">
<h3 id="example-3">Example 3<a class="anchor" aria-label="anchor" href="#example-3"></a>
</h3>
<p>Let say we want to determine which variable in the
<code>mtcars</code> data set is the best predictor of <code>mpg</code>.
To do this we build a linear model for each variable vs <code>mpg</code>
(Note this a toy example not stats advice).</p>
<p>A first attempt might be to right them all out by hand.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span></span>
<span><span class="va">mod_cyl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">gl_cyl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance</a></span><span class="op">(</span><span class="va">mod_cyl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_disp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">disp</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">gl_disp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance</a></span><span class="op">(</span><span class="va">mod_disp</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"disp"</span><span class="op">)</span>, r.squared <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">gl_cyl</span><span class="op">$</span><span class="va">r.squared</span>, <span class="va">gl_disp</span><span class="op">$</span><span class="va">r.squared</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    var r.squared</span></span>
<span><span class="co">#&gt; 1  cyl 0.7261800</span></span>
<span><span class="co">#&gt; 2 disp 0.7183433</span></span>
<span></span>
<span><span class="co"># But for all the variables... sigh</span></span></code></pre></div>
<p>One option is to use a for loop</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html" class="external-link">str_subset</a></span><span class="op">(</span><span class="st">"mpg"</span>, negate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtcars_mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mtcars_vars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">mtcars_vars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"mpg ~ "</span>, <span class="va">mtcars_vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span>  <span class="va">mtcars_mods</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mod</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Another option is to write a function and iteratively apply it to all
the variables</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_mpg_vs_x</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"mpg ~ "</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># name the mtcars_vars list so output is named</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mtcars_vars</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">mtcars_vars</span></span>
<span></span>
<span><span class="va">mtcars_mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">mtcars_vars</span>, <span class="va">fit_mpg_vs_x</span><span class="op">)</span></span></code></pre></div>
<p>I like this better than the for loop because there is less
boilerplate code. But it becomes really useful if we need to apply the
same model to a different set of variables. In a for loop we would need
to repeat the whole thing but since a function is saved as an object we
can easily apply it to a different vector.</p>
<p>Then we can easily apply additional functions to the results to get
our desired output.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://broom.tidymodels.org/" class="external-link">broom</a></span><span class="op">)</span></span>
<span><span class="va">mtcars_mods</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">glance</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span>names_to <span class="op">=</span> <span class="st">"var"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html" class="external-link">fct_reorder</a></span><span class="op">(</span><span class="va">var</span>, <span class="va">r.squared</span><span class="op">)</span>, <span class="va">r.squared</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"R squared"</span>, x <span class="op">=</span> <span class="st">"Variable"</span><span class="op">)</span></span></code></pre></div>
<p><img src="functions_files/figure-html/unnamed-chunk-22-1.png" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="best-practices-for-writing-functions">Best practices for writing functions<a class="anchor" aria-label="anchor" href="#best-practices-for-writing-functions"></a>
</h2>
<p>Before we go on, lets take a moment to introduce two coding practices
that are critical for packages, but will greatly assist you if you get
in the practice now.</p>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a>
</h3>
<p>In a package, function documentation is what you see when you run
<code><a href="https://rdrr.io/r/utils/str.html" class="external-link">?str</a></code>. It names the function, describes its use, outlines
the argument definitions and critically has code examples.</p>
<p>Outside of a package, this is no different than using “#” to add code
comments. However the “roxygen2” package creates some formality to this
that will aid you now and in a package automatically generate a help
file.</p>
<p>In Rstudio, if your cursor is inside a function, you can enter
“ctrl-alt-shift-r” or find “Insert Roxygen skeleton” under “Code” in
your menu bar. This will insert the following pieces above your
function.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Title</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x </span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="va">rescale01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can then go in and add some details about the function:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Rescales a value between 0 and 1 </span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Allows you to take a vector of values or column</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x vector of values to rescale</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns vector of values rescaled</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples </span></span>
<span><span class="co">#'        rescale01(mtcars$mpg)</span></span>
<span><span class="co">#'        </span></span>
<span><span class="co">#'        transmute(mtcars,</span></span>
<span><span class="co">#'              mpg, </span></span>
<span><span class="co">#'              mpg_scaled = rescale01(mpg))</span></span>
<span><span class="co">#'        </span></span>
<span><span class="va">rescale01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>R will ignore all the comments in general use, but Rstudio does
highlight the arguments which makes them easy to read within your code.
The “<span class="citation">@examples</span>” tag allows you to show how
the code is supposed to be run. This is often the only part I look at in
a help page, so worth putting time into if your function is more
complicated.</p>
</div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a>
</h3>
<p>How do we know a function is working as planned? In some cases you’ll
get an error, but not always. Lets go back to the original version
without the <code>na.rm</code> variable (<a href="#documentation">just
above</a>).</p>
<p>With this version of the function if I run the following, I can be
pretty sure I won’t miss these outputs, but do you expect them?</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">rescale01</span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NaN NaN NaN NaN NaN</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">rescale01</span><span class="op">(</span><span class="va">a_r</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] NA NA NA NA NA NA NA NA NA NA NA</span></span></code></pre></div>
<p>To formalize your understanding of what a function should do, we
write tests. The package “testthat” can greatly help with this.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu">test_that</span><span class="op">(</span><span class="st">"All equal returns NaN"</span>,</span>
<span>                    <span class="op">{</span></span>
<span>                      <span class="fu">testthat</span><span class="fu">::</span><span class="fu">expect_equal</span><span class="op">(</span></span>
<span>                        <span class="op">{</span></span>
<span>                          <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu">rescale01</span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span></span>
<span>                          </span>
<span>                        <span class="op">}</span>, </span>
<span>                        <span class="cn">NaN</span> <span class="co"># Here is what we expect the above to return</span></span>
<span>                      <span class="op">)</span></span>
<span>                    <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>In this case, we knew that if all the values are equal the
denominator in our function would be zero. R dividing by zero returns
NaN.</p>
<p>However perhaps we forgot that <code>min</code> and <code>max</code>
have “na.rm=FALSE” by default, so we expect that only the NA in the
second example would be returned as NA:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu">test_that</span><span class="op">(</span><span class="st">"One NA doesn't spoil the batch"</span>,</span>
<span>                    <span class="op">{</span></span>
<span>                      <span class="fu">testthat</span><span class="fu">::</span><span class="fu">expect_equal</span><span class="op">(</span></span>
<span>                        <span class="op">{</span></span>
<span>                          <span class="va">a_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>                          <span class="va">a_r2</span> <span class="op">&lt;-</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">a_r</span><span class="op">)</span></span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">a_r2</span><span class="op">)</span><span class="op">)</span> <span class="co"># Count the number of NA in the output</span></span>
<span>                        <span class="op">}</span>,</span>
<span>                        <span class="fl">1</span> <span class="co"># We expect just one NA in the output</span></span>
<span>                      <span class="op">)</span></span>
<span>                    <span class="op">}</span></span>
<span>                    <span class="op">)</span></span></code></pre></div>
<p>In this case we are expecting only one NA, but as <code>min</code>
<code>max</code> will return NA, all the values in the vector are
returned as NA.</p>
<p>As we saw in the updated function (shown below), we can update the
function to include <code>na.rm</code> as variable with a default of
<code>TRUE</code>.</p>
<p>This modification allowsd us to quickly and easily change the code by
allowing you to chose the na.rm behaviour and setting the default to
TRUE as this is what will usually make sense.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Rescales a value between 0 and 1 </span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Allows you to take a vector of values or column</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x vector of values to rescale</span></span>
<span><span class="co">#' @param na.rm logical should NA values be removed from min/max. Defaults to TRUE</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @returns vector of values rescaled</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples </span></span>
<span><span class="co">#'        rescale01(mtcars$mpg)</span></span>
<span><span class="co">#'        </span></span>
<span><span class="co">#'        transmute(mtcars,</span></span>
<span><span class="co">#'              mpg, </span></span>
<span><span class="co">#'              mpg_scaled = rescale01(mpg))</span></span>
<span><span class="co">#'        </span></span>
<span><span class="va">rescale01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span><span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we change our expectations for the initial test and add a new
test to show what we learned about behaviour when
<code>na.rm=FALSE</code>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu">test_that</span><span class="op">(</span><span class="st">"One NA doesn't spoil the batch, unless I want it to"</span>,</span>
<span>                    <span class="op">{</span></span>
<span>                      <span class="va">a_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>                      </span>
<span>                      <span class="co"># Test default behaviour</span></span>
<span>                      <span class="fu">testthat</span><span class="fu">::</span><span class="fu">expect_equal</span><span class="op">(</span></span>
<span>                        <span class="op">{</span></span>
<span>                         <span class="va">a_r2</span> <span class="op">&lt;-</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">a_r</span><span class="op">)</span></span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">a_r2</span><span class="op">)</span><span class="op">)</span> <span class="co"># Count the number of NA in the output</span></span>
<span>                        <span class="op">}</span>,</span>
<span>                        <span class="fl">1</span></span>
<span>                      <span class="op">)</span></span>
<span>                      </span>
<span>                      <span class="co"># Now we expect all NA if we set na.rm=FALSE</span></span>
<span>                      <span class="fu">testthat</span><span class="fu">::</span><span class="fu">expect_equal</span><span class="op">(</span></span>
<span>                        <span class="op">{</span></span>
<span>                         </span>
<span>                          <span class="va">a_r2</span> <span class="op">&lt;-</span> <span class="fu">rescale01</span><span class="op">(</span><span class="va">a_r</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">a_r2</span><span class="op">)</span><span class="op">)</span> <span class="co"># Count NAs</span></span>
<span>                        <span class="op">}</span>,</span>
<span>                        <span class="fl">11</span></span>
<span>                      <span class="op">)</span></span>
<span>                    <span class="op">}</span></span>
<span>                    <span class="op">)</span></span></code></pre></div>
<p>There is a formal structure in packages for running and storing
tests, but for generic code, you may want a separate file in your
package named ‘tests-rescale01.R’ or
<code>tests-functions.R' to document your tests. Also note, the code within your "testthat" functions won't be exported to your main environment. See the</code>testing-cleaning-funs.R`
in <a href="https://github.com/LandSciTech/rResources" class="external-link">this repo</a> for
an example.</p>
</div>
</div>
<div class="section level2">
<h2 id="when-to-make-it-a-package">When to make it a Package?<a class="anchor" aria-label="anchor" href="#when-to-make-it-a-package"></a>
</h2>
<p>An R package is a collection of functions and metadata that can be
easily shared with other R users. It includes a standardized folder
structure and set of files.</p>
<p>The copy twice rule of thumb applies to whole functions as well. Once
you have copied a function across two separate script it should at least
go in a separate file that is sourced in both scripts so you only need
to change it in one place. Then if you are copying the same helper
functions into multiple projects they should become a package that you
can call in that script with <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library(mypackage)</a></code>.</p>
<p>Another school of thought is that all analysis projects should use a
package structure to organize their code (<a href="https://mdneuzerling.com/post/data-science-workflows/" class="external-link">One
example</a>) or a modified package structure with additional folders
added for analysis and paper writing (<a href="https://github.com/LandSciTech/paper-template-repo" class="external-link">What Sarah
uses</a>).</p>
</div>
<div class="section level2">
<h2 id="how-to-create-a-package">How to create a package<a class="anchor" aria-label="anchor" href="#how-to-create-a-package"></a>
</h2>
<p>The book <a href="https://r-pkgs.org/" class="external-link">R Packages</a> contains
everything you need to know to write a package.<br>
The key files that define a package are:</p>
<ul>
<li>DESCRIPTION: Metadata about the package including dependencies</li>
<li>NAMESPACE: List of imported and exported functions</li>
<li>R: Code that defines the functions of the package</li>
</ul>
<p>Two packages, devtools and usethis, and tools in RStudio make
building your own package pretty easy. For example, all the boilerplate
structure of a package can be created with
<code>usethis::create_package()</code>. You then add new function
scripts with <code>usethis::use_r()</code>, and create tests with
<code>usethis::use_test</code>.</p>
</div>
<div class="section level2">
<h2 id="benefits-of-using-a-package">Benefits of using a package<a class="anchor" aria-label="anchor" href="#benefits-of-using-a-package"></a>
</h2>
<ul>
<li><p>Easy loading and re-loading: call
<code>devtools::load_all()</code> (Ctrl-Shift-L) to source all the
functions in your R directory</p></li>
<li><p>Way to record and install dependencies: record dependencies with
<code>usethis::use_package()</code>, use
<code>devtools::install_deps()</code> to install all the listed
dependencies. (Note this assumes the code works with the most recent
version of dependencies!)</p></li>
<li><p>Documentation: Functions in a package are documented using
Roxygen, special comments that create documentation for your functions.
In RStudio use Code &gt; Insert Roxygen Skeleton or Alt-Ctrl-Shift-R to
insert a template when your cursor is in a function definition.</p></li>
<li><p>pkgdown website: Run
<code>usethis::use_pkgdown_github_pages()</code> to create a website
with the package README as home page, vignettes rendered as articles and
a reference for all the function documentation.(For example the package
<a href="https://landscitech.github.io/roads/" class="external-link">roads</a>)</p></li>
<li><p>Testing: Unit tests ensure your functions continue doing what you
expect when you make changes or update dependencies.
<code>usethis::use_testthat()</code> sets up the testing architecture
and <code>usethis::use_test</code> opens a new test file.
<code>usethis::use_github_action()</code> sets up GitHub actions to run
R CMD check which includes your tests on GitHub every time you commit to
the main branch aka Continuous Integration testing.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="cran-or-not">CRAN or not<a class="anchor" aria-label="anchor" href="#cran-or-not"></a>
</h2>
<p>If you get to the point of creating a package you want to share, one
question might be “How?”.</p>
<p>Most people who use R will only use <code>install.packages</code>. If
you are planning on sharing your packages with folks with limited
technical experience or limited permissions on their computer, then
<code>install.packages</code> is the lowest barrier to entry for users.
It is however unfortunately the highest barrier for you as the package
developer. Basic usage of the function requires the package to be on <a href="https://cran.r-project.org/web/packages/available_packages_by_name.html" class="external-link">CRAN</a>.
There is a good chapter on submitting to CRAN here: <a href="https://r-pkgs.org/release.html" class="external-link">https://r-pkgs.org/release.html</a>.</p>
<p>A step up in difficulty for the user is to use the <a href="https://r-universe.dev/search" class="external-link">r-universe</a> website to host your
binary files. R-universe does not generally require extra packages or
software (like <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">Rtools</a> or the
“<a href="https://devtools.r-lib.org/" class="external-link">devtools</a>” package). It
requires a bit more work to setup, but there are some good <a href="https://ropensci.org/blog/2021/06/22/setup-runiverse/" class="external-link">walkthroughs</a>
out there.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"naturecounts"</span>, </span>
<span>                 repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>birdscanada <span class="op">=</span> <span class="st">'https://birdscanada.r-universe.dev'</span>,</span>
<span>                           CRAN <span class="op">=</span> <span class="st">'https://cloud.r-project.org'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If you build your package locally, it can be installed with:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"file://path/to/file.zip"</span>, repos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>However, this requires separate files for each operating system, and
will often throw errors based on each users computer eccentricities and
requires sharing the file each time you update.</p>
<p>Perhaps the easiest for you is to use GitHub. This will allow users
to install using simple packages like “remotes” or “pak”.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"BirdsCanada/naturecounts"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pak.html" class="external-link">pak</a></span><span class="op">(</span><span class="st">"BirdsCanada/naturecounts"</span><span class="op">)</span></span></code></pre></div>
<p>The downside is this will require installation from “source”, which
requires the “Rtools” in Windows and may require other software
installations in other OS.</p>
<p>If you are considering CRAN, start planning early:</p>
<ol style="list-style-type: decimal">
<li><p>Limit dependencies</p></li>
<li><p>Create tests as you build</p></li>
<li><p>Document everything public facing (and well).</p></li>
<li><p>Run tests locally and on a server</p></li>
<li><p>Expect some back and forth when you submit</p></li>
<li><p>Use <code>usethis::use_release_issue()</code> to get a checklist
of things to do before submitting to help avoid issues</p></li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sarah Endicott.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
